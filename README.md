# Нагрузочное тестирование сайтов

Сервис имеет один единственный эндпоинт `/sites?search=<query>`. Из выдачи яндекса,
сформированной по запросу `<query>`, извлекаются ссылки на сайты. Затем для каждого 
сайта производится нагрузочное тестирование: определяется какое максимальное количество
запросов выдерживает сайт.

### Конфигурация

Описание конфига
```yaml
service:
  listen: ":50070" # адрес, на котором запускается сервис
  base_yandex_url: "https://yandex.ru/search/touch/?service=www.yandex&ui=webmobileapp.yandex&numdoc=50&lr=213&p=0&text=%s" # урл для получения поисковой выдачи
  use_proxy: "false" # использовать прокси для запросов
  check_proxy: "false" # проверять прокси при запуске
  check_proxy_url: "https://www.yandex.ru/" # урл для проверки прокси
  proxy_path: "proxy.txt" # список прокси
  write_logs_to_file: "true" # писать логи в файл
  log_path: "checker.log" # путь логов
  log_level: "debug" # минимальный уровень логгирования
data_provider:
  timeout_in_ms: 3000 # таймаут запроса в милисекундах, он же используется для проверки прокси
  proxy_test_attempt: 10 # кол-во попыток загрузки сайта через прокси, каждая попытка - новые прокси
checker:
  init_thread_count: 8 # начальное кол-во потоков для тестирования сайта
  max_search_iteration: 3 # кол-во попыток тестирвания сайта после первой неудачной
  test_threads_err_threshold: 0.1 # максимальный процент ошибок при тестировании сайта
  timeout_in_ms_between_attempts: 500 # таймаут между попытками тестирования сайта
  max_parallel_host_testing: 20 # кол-во одновременно тестируемых сайтов
  host_test_count: 1 # кол-во тестов без изменения кол-ва потоков
  cache_fail: "true" # кешировать неудачне результаты теста
```

Рекомендуемые настройки для домашнего компьютера, чтобы получать ответ в течении 30с:
```yaml
checker:
  init_thread_count: 8
  max_search_iteration: 3
  test_threads_err_threshold: 0.1
  timeout_in_ms_between_attempts: 500
  max_parallel_host_testing: 20
  host_test_count: 1
```
Эти параметры влияют на точность тестов. Рекомендуемые настройки для серевера уточняйте у админа.

### Логика тестирования

После получения ссылок на сайты для тестирования, тесты запускаются одновременно для 
нескольких хостов (регулируется параметром `max_parallel_host_testing`). Если 
результаты тестирования есть в кэше, то они берутся из кеша. Перед тестированием 
каждый хост проверяется на доступность одним запросом. Если хост доступен, он вначале 
тестируется на `init_thread_count` параллельных запросах.


Тестирование успешно, если количесвто ошибок <= **current_thread_count** * `test_threads_err_threshold`, 
округлённое до большего целого. После первого неудачного тетсирования, будет сделано 
ещё `max_search_iteration` тестов для точного определения верхней границы. На каждой 
итерации корректируется кол-во потоков.

Чтобы убедиться, что с текущим кол-вом потоков сайт действтельно рабоает стабильно, 
будет сделано `host_test_count` тестов с текущим кол-вом потоков.


### Эндпоинты
GET `/sites?search=<query>&withoutProxy=<true|false>&withoutCache=<true|false>`  
- search - поисковый запрос
- withoutProxy - делать запросы без прокси
- withoutCache - не использовать кэш

Формат ответа
```json
[
  {
    "Host": "samsung.com",
    "Threads": 64
  },
  {
    "Host": "e-katalog.ru",
    "Threads": 16
  },
  {
    "Host": "holodilnik.ru",
    "Threads": 64
  },
  {
    "Host": "online-samsung.ru",
    "Threads": 128
  }
]
```

### Запуск

В докере сервис запускается командами:
```
docker build . -t highloadtest
docker run -p 50070:50070 -t highloadtest
```
